# 总需求（基于现有代码与需求文档对照）

本文件整合《API完整需求.md》《API需求_完善.md》《AI功能使用示例.md》，并对当前后端实现的匹配度进行标注。

## 1. 认证与通用约定
- 需求：所有请求包含 time、token（登录接口 token 为 null）；多数接口需要 Bearer Token。
- 实现现状：路由实现中未强制校验 token/Authorization（需补充中间件或依赖）。请求体依赖 Pydantic 校验，但未应用鉴权。

## 2. 用户
- 需求：注册/登录/登出/用户资料 CRUD，含 profile、sessions、密码重置、邮箱验证。
- 现状：`/user/register`、`/user/login`、`/user/logout`、`/user/profile/{id}` GET/PUT/DELETE 已实现基础版；未实现 sessions、密码重置、邮箱验证、role/locale/avatar 等字段；token 仅生成未校验。
- 差异：请求体字段与文档不完全一致（login 用 email+password，文档示例含 username；profile 缺 bio/job_title/avatar）。

## 3. 组织 / 工作空间
- 需求：组织(org) CRUD、成员管理；工作空间 CRUD + 成员管理。
- 现状：仅工作空间 CRUD（`/workspaces`）基础实现；无组织路由、无成员管理接口。
- 差异：缺 org 路由、workspace_members 增删查。

## 4. 项目
- 需求：项目 CRUD，过滤（workspace_id/owner_id），软删除。
- 现状：`/projects` 路由提供 CRUD；过滤只支持 workspace_id 参数，未支持 owner_id；软删除已做。
- 差异：缺成员/角色、分页/排序。

## 5. 任务 / 子任务 / 依赖 / 活动
- 需求：任务 CRUD，状态/指派更新，过滤（project/assignee/status/workspace），子任务、依赖、活动日志。
- 现状：`/tasks` 路由提供 CRUD；过滤仅支持 workspace_id / 可选 project_id；无子任务、依赖、活动日志；无 assign/status 专用接口；无分页。
- 差异：未覆盖 subtasks、task_dependencies、task_activity_logs。

## 6. 标签与自定义字段
- 需求：标签 CRUD（workspace 唯一）；任务标签关联；自定义字段及任务字段值。
- 现状：`/tags` 路由仅支持创建/列表和任务 attach/detach；无标签更新/删除；无 custom_fields / task_custom_field_values。
- 差异：缺标签更新/删除；缺自定义字段全套。

## 7. 评论
- 需求：评论 CRUD，按资源查询。
- 现状：`/comments` 路由支持创建、列表、删除；无更新接口。
- 差异：缺更新；未限制 resource_type 枚举。

## 8. 附件
- 需求：附件上传/列表/删除；存储键、metadata。
- 现状：`/attachments` 路由支持创建、列表、删除（记录 metadata/存储键）；未实现文件流/存储上传，仅元数据。
- 差异：无 multipart/直传支持。

## 9. 通知 / 提醒
- 需求：通知列表、标记已读、删除；提醒创建/列表。
- 现状：`/notifications` 路由支持创建、列表、标记已读；无删除；无 reminders 路由。
- 差异：缺 reminders；通知删除未实现。

## 10. 搜索
- 需求：任务/项目搜索（全文检索，或 /search 通用）。
- 现状：`/search` GET 返回 tasks+projects 统一结果；无 /search/tasks 或 /search/projects 拆分；未使用 tsvector（使用 ILIKE 回退）。
- 差异：路径与文档不完全一致；无分页/过滤参数。

## 11. AI 功能
- 需求：任务分解、任务建议、对话；记录 ai_requests。
- 现状：`/ai/decompose` 使用流式收集 JSON；`/ai/suggestions/{task_id}` 同步调用；`/ai/chat`、`/ai/chat-stream` 存在；保存 ai_requests；提示词从 settings.py 注入。
- 差异：未实现 ai 请求/建议的状态管理、模型列表等扩展。

## 12. 其他（未实现部分）
- 模板/智能列表、时间追踪、集成/API Key/Webhook、审计、usage_events、日历集成、订阅支付等均未在当前代码中体现。
- 前端/上传/鉴权中间件尚缺。

## 13. 建议的落地顺序
1) 补齐鉴权：统一 Header token 校验，中间件/依赖。
2) 组织/成员、标签更新/删除、自定义字段、子任务/依赖/活动日志。
3) 搜索分页与过滤，路径与文档对齐（兼容现有 /search）。
4) Reminders、通知删除；Multipart 上传或直传方案。
5) 其余扩展：模板、时间追踪、集成、审计、API Key 等。

## 14. 参考文件
- 《API完整需求.md》：列出各资源基础 CRUD 与示例。
- 《API需求_完善.md》：基于数据库模式的契约与扩展需求（子任务、依赖、活动、集成等）。
- 《AI功能使用示例.md》：AI 分解/建议/对话接口示例与配置说明。
